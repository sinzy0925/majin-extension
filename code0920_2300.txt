background.jsã€€ã®
const SCRIPT_ID = "1YUAmadVwnkM44Uld694CgPgmmkEFiSNmjklnhosfW7P6G7D5uAgv0R5o";
ã‚’ã€popup.htmlã§å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚
DEFAULT_SETTINGSã®ä¸€ã¤ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã®ã¯ã©ã†ã‚„ã‚ã‹ï¼Ÿ

---



ä»¥ä¸‹ã®ã‚¢ãƒ—ãƒªã‚’è©³ç´°ã«ç†è§£ã—ã¦ãã ã•ã„ã€‚



//manifest.json
{
  "manifest_version": 3,
  "name": "ã‚¹ãƒ©ã‚¤ãƒ‰è‡ªå‹•ç”Ÿæˆ",
  "version": "5.0",
  "description": "AIã¨é€£æºã—ã¦Googleã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚",
  "action": {
    "default_popup": "popup.html"
  },
  "background": {
    "service_worker": "background.js"
  },
  "content_scripts": [
    {
      "matches": ["https://www.youtube.com/*"],
      "js": ["jquery.min.js", "content.js"]
    }
  ],
  "permissions": [
    "identity",
    "tabs",
    "storage" 
  ],
  "host_permissions": [
    "<all_urls>"
  ],
  "oauth2": {
    "client_id": "77855084094-c3jal48g1hd0emb487ggobtakrpsk6a2.apps.googleusercontent.com",
    "scopes": [
      "https://www.googleapis.com/auth/script.projects",
      "https://www.googleapis.com/auth/script.deployments",
      "https://www.googleapis.com/auth/script.scriptapp",
    "https://www.googleapis.com/auth/presentations",
    "https://www.googleapis.com/auth/drive"         
    ]
  },
  "web_accessible_resources": [
    {
      "resources": [
        "0.gs",
        "1.gs",
        "3.gs",
        "system_prompt.txt"
      ],
      "matches": [ "<all_urls>" ]
    }
  ],
  "content_security_policy": {
    "extension_pages": "script-src 'self'; object-src 'self'; connect-src https://generativelanguage.googleapis.com/ https://script.googleapis.com/ https://script.google.com/ https://script.googleusercontent.com/;"
  }
}

---

// background.js

// --- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š (åˆå›èµ·å‹•æ™‚ã‚„ãƒªã‚»ãƒƒãƒˆæ™‚ã«ä½¿ç”¨) ---
const DEFAULT_SETTINGS = {
  deploymentId: "AKfycbzRaZy6u-VwYU-_misbfeiorUw-2U83A6lLaG1ROqC_ZAZb0ZKSdvirLiaNWtbHpTKWGA",
  apiKey: "",
  aiModel: 'gemini-2.5-flash'
};

const SCRIPT_ID = "1YUAmadVwnkM44Uld694CgPgmmkEFiSNmjklnhosfW7P6G7D5uAgv0R5o";
let activePort = null;

// --- æ¥ç¶šãƒªã‚¹ãƒŠãƒ¼ ---
chrome.runtime.onConnect.addListener((port) => {
  console.assert(port.name === "generate-channel");
  activePort = port;

  port.onMessage.addListener((msg) => {
    if (msg.action === "generateSlidesWithAI") {
      generateSlidesWithAI(msg.prompt, msg.settings);
    } else if (msg.action === "regenerateWithDesign") { // â–¼â–¼â–¼ è¿½åŠ  â–¼â–¼â–¼
      regenerateWithDesign(msg.settings);
    }
  });

  port.onDisconnect.addListener(() => {
    activePort = null;
  });
});

// --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ (popup.jsã‹ã‚‰ã®åŒæœŸçš„ãªè¦æ±‚ã«å¿œãˆã‚‹) ---
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === 'getDefaultApiSettings') {
    sendResponse({
      deploymentId: DEFAULT_SETTINGS.deploymentId,
      apiKey: DEFAULT_SETTINGS.apiKey,
      aiModel: DEFAULT_SETTINGS.aiModel
    });
  }
  return true;
});


// --- é€²æ—ã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«é€ä¿¡ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
function sendProgress(response) {
  if (activePort) {
    activePort.postMessage(response);
  }
}

// --- æ©Ÿèƒ½: ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šã§0.gsã®å†…å®¹ã‚’æ›¸ãæ›ãˆã‚‹ ---
function createFile0Source(baseSource, settings) {
    let source = baseSource;
    if (settings) {
        if (settings.footerText) { source = source.replace(/const str_FOOTER_TEXT = `.*`;/, `const str_FOOTER_TEXT = \`${settings.footerText}\`;`); }
        if (settings.headerLogo) { source = source.replace(/const str_LOGOS_header= '.*'/, `const str_LOGOS_header= '${settings.headerLogo}'`); }
        if (settings.closingLogo) { source = source.replace(/const str_LOGOS_closing= '.*'/, `const str_LOGOS_closing= '${settings.closingLogo}'`); }
        if (settings.primaryColor) { source = source.replace(/const str_primary_color= '.*';/, `const str_primary_color= '${settings.primaryColor}';`); }
        const formatUrl = (url) => url ? `"${url}"` : 'null';
        if (settings.titleBg !== undefined) { source = source.replace(/const str_title_background_image_url= .*?;/, `const str_title_background_image_url= ${formatUrl(settings.titleBg)};`); }
        if (settings.contentBg !== undefined) { source = source.replace(/const str_content_background_image_url= .*?;/, `const str_content_background_image_url= ${formatUrl(settings.contentBg)};`); }
        if (settings.closingBg !== undefined) { source = source.replace(/const str_closing_background_image_url= .*?;/, `const str_closing_background_image_url= ${formatUrl(settings.closingBg)};`); }
    }
    return source;
}

// --- ãƒ¡ã‚¤ãƒ³ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆé–¢æ•° ---
async function generateSlidesWithAI(userPrompt, settings) {
  try {
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${settings.aiModel}:generateContent?key=${settings.apiKey}`;

    sendProgress({ status: 'progress', message: 'AIãŒã‚¹ãƒ©ã‚¤ãƒ‰æ§‹æˆæ¡ˆã‚’ä½œæˆä¸­...'});
    const slideDataString = await getSlideDataFromAI(userPrompt, API_URL);
    
    sendProgress({ status: 'progress', message: 'GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æº–å‚™ä¸­...'});
    const token = await getAuthToken();

    const baseFile0Source = await fetch(chrome.runtime.getURL('0.gs')).then(res => res.text());
    const file0Source = createFile0Source(baseFile0Source, settings);
    
    const file1Source = await fetch(chrome.runtime.getURL('1.gs')).then(res => res.text());
    const file3Source = await fetch(chrome.runtime.getURL('3.gs')).then(res => res.text());
    
    sendProgress({ status: 'progress', message: 'GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°ä¸­...'});
    const newSource = createProjectSource(file0Source, file1Source, slideDataString, file3Source);
    await updateGasProject(SCRIPT_ID, token, newSource);

    sendProgress({ status: 'progress', message: 'æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆä¸­...'});
    const versionResponse = await createNewVersion(SCRIPT_ID, token);
    const newVersionNumber = versionResponse.versionNumber;

    sendProgress({ status: 'progress', message: `ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ›´æ–°ä¸­ (v${newVersionNumber})...` });
    await updateDeployment(SCRIPT_ID, settings.deploymentId, token, newVersionNumber);

    sendProgress({ status: 'progress', message: 'ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...'});
    const WEB_APP_URL = `https://script.google.com/macros/s/${settings.deploymentId}/exec`;
    const result = await executeWebApp(WEB_APP_URL);
    
    sendProgress({ status: 'success', message: 'å®Œäº†: ' + result.message });

  } catch (error) {
    console.error("ã€CRITICAL ERRORã€‘:", error);
    sendProgress({ status: 'error', message: error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ã§ã™ã€‚' });
  }
}

// --- â–¼â–¼â–¼ æ–°ã—ã„é–¢æ•° â–¼â–¼â–¼ ---
// --- ãƒ‡ã‚¶ã‚¤ãƒ³ã®ã¿åæ˜ ã—ã¦å†ç”Ÿæˆã™ã‚‹é–¢æ•° ---
async function regenerateWithDesign(settings) {
    try {
        sendProgress({ status: 'progress', message: 'ãƒ‡ã‚¶ã‚¤ãƒ³åæ˜ ã®æº–å‚™ã‚’é–‹å§‹...'});
        const token = await getAuthToken();

        sendProgress({ status: 'progress', message: 'ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰æ§‹æˆ(2.gs)ã‚’å–å¾—ä¸­...'});
        const currentProject = await getGasProjectContent(SCRIPT_ID, token);
        const slideDataString = currentProject.files.find(f => f.name === '2')?.source;

        if (!slideDataString) {
            throw new Error("æ—¢å­˜ã®ã‚¹ãƒ©ã‚¤ãƒ‰æ§‹æˆ(2.gs)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä¸€åº¦ã€Œå…¨è‡ªå‹•ã§ç”Ÿæˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
        }

        const baseFile0Source = await fetch(chrome.runtime.getURL('0.gs')).then(res => res.text());
        const file0Source = createFile0Source(baseFile0Source, settings);

        const file1Source = await fetch(chrome.runtime.getURL('1.gs')).then(res => res.text());
        const file3Source = await fetch(chrome.runtime.getURL('3.gs')).then(res => res.text());
        
        sendProgress({ status: 'progress', message: 'GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°ä¸­...'});
        const newSource = createProjectSource(file0Source, file1Source, slideDataString, file3Source);
        await updateGasProject(SCRIPT_ID, token, newSource);

        sendProgress({ status: 'progress', message: 'æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆä¸­...'});
        const versionResponse = await createNewVersion(SCRIPT_ID, token);
        const newVersionNumber = versionResponse.versionNumber;

        sendProgress({ status: 'progress', message: `ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ›´æ–°ä¸­ (v${newVersionNumber})...` });
        await updateDeployment(SCRIPT_ID, settings.deploymentId, token, newVersionNumber);

        sendProgress({ status: 'progress', message: 'ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å†ç”Ÿæˆã—ã¦ã„ã¾ã™...'});
        const WEB_APP_URL = `https://script.google.com/macros/s/${settings.deploymentId}/exec`;
        const result = await executeWebApp(WEB_APP_URL);
        
        sendProgress({ status: 'success', message: 'å®Œäº†: ãƒ‡ã‚¶ã‚¤ãƒ³ãŒåæ˜ ã•ã‚Œã¾ã—ãŸã€‚' });

    } catch (error) {
        console.error("ã€CRITICAL ERROR in regenerateã€‘:", error);
        sendProgress({ status: 'error', message: error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ã§ã™ã€‚' });
    }
}
// --- â–²â–²â–² æ–°ã—ã„é–¢æ•°ã“ã“ã¾ã§ â–²â–²â–² ---


// -----------------------------------------------------------------------------
// --- è£œåŠ©é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—ã®ã‚‚ã®ã¯çœç•¥) ---
// -----------------------------------------------------------------------------

async function getSlideDataFromAI(userPrompt, apiUrl) {
  const systemPrompt = await fetch(chrome.runtime.getURL('system_prompt.txt')).then(res => res.text());
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 120000);
  try {
    const response = await fetch(apiUrl, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: systemPrompt + "\n\n---\n\n" + userPrompt }] }],
        safetySettings: [
          { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
        ]
      }),
      signal: controller.signal
    });
    clearTimeout(timeoutId);
    if (!response.ok) { const errorData = await response.json(); throw new Error(`AI APIã‚¨ãƒ©ãƒ¼: ${errorData.error.message}`); }
    const data = await response.json();
    if (!data.candidates || data.candidates.length === 0) { throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); }
    let rawText = data.candidates[0].content.parts[0].text;
    rawText = rawText.replace(/^```javascript\s*/, '').replace(/```\s*$/, '');
    return rawText.trim();
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') { throw new Error("AI APIã‹ã‚‰ã®å¿œç­”ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ120ç§’ï¼‰ã€‚"); }
    throw error;
  }
}

function getAuthToken() {
  return new Promise((resolve, reject) => {
    chrome.identity.getAuthToken({ interactive: true }, (token) => {
      if (chrome.runtime.lastError) { reject(chrome.runtime.lastError); } else { resolve(token); }
    });
  });
}

function createProjectSource(file0,file1, file2, file3) {
  const manifestContent = `{
    "timeZone": "Asia/Tokyo", "dependencies": {}, "exceptionLogging": "STACKDRIVER",
    "runtimeVersion": "V8", "webapp": { "executeAs": "USER_DEPLOYING", "access": "ANYONE_ANONYMOUS" }
  }`;
  return {
    files: [
      { name: "appsscript", type: "JSON", source: manifestContent }, 
      { name: "0", type: "SERVER_JS", source: file0 },
      { name: "1", type: "SERVER_JS", source: file1 },
      { name: "2", type: "SERVER_JS", source: file2 }, 
      { name: "3", type: "SERVER_JS", source: file3 }
    ]
  };
}

async function updateGasProject(scriptId, token, source) {
  const url = `https://script.googleapis.com/v1/projects/${scriptId}/content`;
  const response = await fetch(url, {
    method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify(source)
  });
  if (!response.ok) { const errorData = await response.json(); throw new Error(`GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ã«å¤±æ•—: ${errorData.error.message}`); }
  return await response.json();
}

async function getGasProjectContent(scriptId, token) {
  const url = `https://script.googleapis.com/v1/projects/${scriptId}/content?fields=files(name,source)`;
  const response = await fetch(url, { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } });
  if (!response.ok) { const errorData = await response.json(); throw new Error(`GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…å®¹ã®å–å¾—ã«å¤±æ•—: ${errorData.error.message}`); }
  return await response.json();
}

async function createNewVersion(scriptId, token) {
  const url = `https://script.googleapis.com/v1/projects/${scriptId}/versions`;
  const response = await fetch(url, {
    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ description: `Auto-deployed by extension at ${new Date().toISOString()}` })
  });
  if (!response.ok) { const errorData = await response.json(); throw new Error(`GASã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—: ${errorData.error.message}`); }
  return await response.json();
}

async function updateDeployment(scriptId, deploymentId, token, versionNumber) {
  const url = `https://script.googleapis.com/v1/projects/${scriptId}/deployments/${deploymentId}`;
  const response = await fetch(url, {
    method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      deploymentConfig: { scriptId: scriptId, versionNumber: versionNumber, description: `Updated by extension to v${versionNumber}` }
    })
  });
  if (!response.ok) { const errorData = await response.json(); throw new Error(`GASã®ãƒ‡ãƒ—ãƒ­ã‚¤æ›´æ–°ã«å¤±æ•—: ${errorData.error.message}`); }
  return await response.json();
}

async function executeWebApp(url) {
  const response = await fetch(url, { method: 'POST', cache: 'no-cache' });
  if (!response.ok) { const errorText = await response.text(); throw new Error(`ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ${response.status}`); }
  const text = await response.text();
  try {
    const jsonResponse = JSON.parse(text);
    if (jsonResponse.logs && Array.isArray(jsonResponse.logs)) {
      console.groupCollapsed("ğŸ“‹ Google Apps Scriptã‹ã‚‰ã®ãƒ­ã‚°");
      jsonResponse.logs.forEach(log => { console.log(log); sendProgress({ status: 'progress', message: log }); });
      console.groupEnd();
    }
    if (jsonResponse.status === 'error') { throw new Error(`GASå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${jsonResponse.message}`); }
    return jsonResponse;
  } catch (e) {
    throw new Error("ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªå¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
}

---

//popup.html

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { width: 600px; padding: 10px; font-family: sans-serif; box-sizing: border-box; }
    h3, h4 { text-align: center; margin-bottom: 10px; }
    h4 { font-weight: normal; color: #555; margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
    
    textarea, .settings-item input {
      width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px;
    }
    textarea { height: 150px; resize: vertical; }

    button { padding: 12px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px; }
    button:disabled { cursor: not-allowed; }
    
    #generate-button { width: 100%; background-color: #4285F4; color: white; margin-bottom: 15px; }
    #generate-button:disabled { background-color: #a0c3ff; }
    
    .settings-group { margin-top: 10px; }
    
    .settings-item { display: flex; align-items: center; margin-bottom: 12px; }
    .settings-item label { flex: 0 0 160px; font-size: 14px; color: #333; padding-right: 10px; }
    .settings-item input { flex: 1; margin-bottom: 0; }
    
    .regenerate-section { padding-top: 10px; border-top: 1px solid #ccc; }
    .settings { display: flex; align-items: center; margin-bottom: 10px; }
    .settings label { flex: 1; }
    
    #regenerate-button { width: 100%; background-color: #34A853; color: white; }
    #regenerate-button:disabled { background-color: #a7d7b4; }
    
    .action-buttons { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
    .action-buttons button { width: 150px; font-size: 14px; padding: 8px; }
    #save-settings-button { background-color: #0F9D58; color: white; }
    #reset-settings-button { background-color: #6c757d; color: white; }
    #feedback-message { flex: 1; font-size: 14px; color: #0F9D58; padding-left: 10px; }

    .collapsible {
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      text-align: left;
    }
    .collapsible-content {
      padding-top: 10px;
      display: none;
      overflow: hidden;
    }
    
    /* â–¼â–¼â–¼ å¤‰æ›´ç®‡æ‰€ â–¼â–¼â–¼ */
    #status-message {
      margin-top: 15px;
      font-size: 14px;
      min-height: 20px;
      text-align: center;
      color: #333;
      padding: 8px; /* å†…å´ã®ä½™ç™½ã‚’è¿½åŠ  */
      border-radius: 4px; /* è§’ã‚’ä¸¸ãã™ã‚‹ */
      background-color: #e8f0fe; /* è–„ã„é’ç³»ã®èƒŒæ™¯è‰² */
    }
    /* â–²â–²â–² å¤‰æ›´ç®‡æ‰€ â–²â–²â–² */

  </style>
</head>
<body>
  <h3>ã‚¹ãƒ©ã‚¤ãƒ‰åŸç¨¿å…¥åŠ›</h3>
  <textarea id="user-prompt" placeholder="ã“ã“ã«ã‚¹ãƒ©ã‚¤ãƒ‰ã«ã—ãŸã„å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
  
  <div class="settings-group">
    <h4>ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š</h4>
    <div class="settings-item">
      <label for="footer-text">ãƒ•ãƒƒã‚¿ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ</label>
      <input type="text" id="footer-text" placeholder="èª­ã¿è¾¼ã¿ä¸­...">
    </div>
    <div class="settings-item">
      <label for="header-logo">ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´URL</label>
      <input type="text" id="header-logo" placeholder="èª­ã¿è¾¼ã¿ä¸­...">
    </div>
    <div class="settings-item">
      <label for="closing-logo">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ãƒ­ã‚´URL</label>
      <input type="text" id="closing-logo" placeholder="èª­ã¿è¾¼ã¿ä¸­...">
    </div>
    <div class="settings-item">
      <label for="title-bg">ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯ç”»åƒURL</label>
      <input type="text" id="title-bg">
    </div>
    <div class="settings-item">
      <label for="content-bg">æœ¬æ–‡èƒŒæ™¯ç”»åƒURL</label>
      <input type="text" id="content-bg">
    </div>
    <div class="settings-item">
      <label for="closing-bg">æœ€çµ‚é  èƒŒæ™¯ç”»åƒURL</label>
      <input type="text" id="closing-bg">
    </div>
    <div class="settings">
      <label for="primary-color">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼:</label>
      <input type="color" id="primary-color" value="#4285F4">
    </div>

    <div class="settings-group">
      <h4 class="collapsible">â–¼ APIãƒ»é€£æºè¨­å®š (å¿…é ˆé …ç›®ã§ã™)</h4>
      <div class="collapsible-content">
        <div class="settings-item">
          <label for="deployment-id">Deployment ID</label>
          <input type="text" id="deployment-id">
        </div>
        <div class="settings-item">
          <label for="api-key">API Key</label>
          <input type="password" id="api-key">
        </div>
        <div class="settings-item">
          <label for="ai-model">AI Model</label>
          <input type="text" id="ai-model">
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button id="save-settings-button">è¨­å®šã‚’ä¿å­˜</button>
      <button id="reset-settings-button">åˆæœŸçŠ¶æ…‹ã«æˆ»ã™</button>
      <span id="feedback-message"></span>
    </div>
  </div>


  <button id="generate-button">å…¨è‡ªå‹•ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆ</button>
  <p id="status-message"></p>

  <div class="regenerate-section">
    <h4>å¾®èª¿æ•´ã—ã¦å†ç”Ÿæˆ</h4>
    <button id="regenerate-button">ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åæ˜ ã—ã¦å†ç”Ÿæˆ</button>
  </div>
  
  <script src="popup.js"></script>
</body>
</html>

---

// popup.js
// popup.js
document.addEventListener('DOMContentLoaded', () => {
  // --- DOMè¦ç´ ã®å–å¾— ---
  const userPrompt = document.getElementById('user-prompt');
  const statusMessage = document.getElementById('status-message');
  const generateBtn = document.getElementById('generate-button');
  const regenerateBtn = document.getElementById('regenerate-button');
  
  const designInputs = {
    footerText: document.getElementById('footer-text'),
    headerLogo: document.getElementById('header-logo'),
    closingLogo: document.getElementById('closing-logo'),
    titleBg: document.getElementById('title-bg'),
    contentBg: document.getElementById('content-bg'),
    closingBg: document.getElementById('closing-bg'),
    primaryColor: document.getElementById('primary-color'),
  };

  const apiInputs = {
    deploymentId: document.getElementById('deployment-id'),
    apiKey: document.getElementById('api-key'),
    aiModel: document.getElementById('ai-model'),
  };

  const saveBtn = document.getElementById('save-settings-button');
  const resetBtn = document.getElementById('reset-settings-button');
  const feedbackMessage = document.getElementById('feedback-message');
  
  const collapsible = document.querySelector('.collapsible');
  const collapsibleContent = document.querySelector('.collapsible-content');

  const SETTINGS_KEY = 'userAppSettings';
  let port = null;

  // --- æ©Ÿèƒ½: æŠ˜ã‚ŠãŸãŸã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ¶å¾¡ ---
  collapsible.addEventListener('click', () => {
    const isExpanded = collapsible.classList.toggle('active');
    collapsibleContent.style.display = isExpanded ? 'block' : 'none';
    collapsible.textContent = isExpanded ? 'â–² APIãƒ»é€£æºè¨­å®š (ä¸Šç´šè€…å‘ã‘)' : 'â–¼ APIãƒ»é€£æºè¨­å®š (ä¸Šç´šè€…å‘ã‘)';
  });

  // --- æ©Ÿèƒ½: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º ---
  function showFeedback(message, isError = false) {
    feedbackMessage.textContent = message;
    feedbackMessage.style.color = isError ? '#D93025' : '#0F9D58';
    setTimeout(() => { feedbackMessage.textContent = ''; }, 4000);
  }

  // --- æ©Ÿèƒ½: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®å–å¾— ---
  async function getDefaultSettings() {
    const designDefaults = await (async () => {
      try {
        const res = await fetch(chrome.runtime.getURL('0.gs'));
        const text = await res.text();
        return {
          footerText: (text.match(/const str_FOOTER_TEXT = `([^`]+)`/) || [])[1]?.replace('${new Date().getFullYear()}', new Date().getFullYear()) || '',
          headerLogo: (text.match(/const str_LOGOS_header= '([^']+)'/) || [])[1] || '',
          closingLogo: (text.match(/const str_LOGOS_closing= '([^']+)'/) || [])[1] || '',
          primaryColor: (text.match(/const str_primary_color= '([^']+)';/) || [])[1] || '#4285F4',
          titleBg: (text.match(/const str_title_background_image_url= (.*?);/) || [])[1]?.replace(/["']/g, '').replace('null', '') || '',
          contentBg: (text.match(/const str_content_background_image_url= (.*?);/) || [])[1]?.replace(/["']/g, '').replace('null', '') || '',
          closingBg: (text.match(/const str_closing_background_image_url= (.*?);/) || [])[1]?.replace(/["']/g, '').replace('null', '') || ''
        };
      } catch (e) { return {}; }
    })();
    const apiDefaults = await chrome.runtime.sendMessage({ action: "getDefaultApiSettings" });
    return { ...designDefaults, ...apiDefaults };
  }

  // --- æ©Ÿèƒ½: è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜  ---
  function applySettingsToForm(settings) {
    if (!settings) return;
    Object.keys(designInputs).forEach(key => { designInputs[key].value = settings[key] || ''; });
    Object.keys(apiInputs).forEach(key => { apiInputs[key].value = settings[key] || ''; });
  }
  
  // --- æ©Ÿèƒ½: ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã‹ã‚‰è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾— ---
  function getSettingsFromForm() {
    const settings = {};
    Object.keys(designInputs).forEach(key => { settings[key] = designInputs[key].value.trim(); });
    Object.keys(apiInputs).forEach(key => { settings[key] = apiInputs[key].value.trim(); });
    return settings;
  }

  // --- ãƒ¡ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿å‡¦ç† ---
  async function loadSettings() {
    const saved = (await chrome.storage.local.get([SETTINGS_KEY]))[SETTINGS_KEY];
    if (saved && Object.keys(saved).length > 0) {
      applySettingsToForm(saved);
    } else {
      const defaults = await getDefaultSettings();
      applySettingsToForm(defaults);
    }
  }

  loadSettings();

  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼: ä¿å­˜ãƒœã‚¿ãƒ³ ---
  saveBtn.addEventListener('click', () => {
    const settingsToSave = getSettingsFromForm();
    chrome.storage.local.set({ [SETTINGS_KEY]: settingsToSave }, () => {
      showFeedback('âœ“ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });
  });

  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼: ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ ---
  resetBtn.addEventListener('click', () => {
    chrome.storage.local.remove([SETTINGS_KEY], async () => {
      const defaults = await getDefaultSettings();
      applySettingsToForm(defaults);
      showFeedback('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    });
  });

  // --- æ©Ÿèƒ½: ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒãƒ¼ãƒˆæ¥ç¶šã‚’æº–å‚™ã™ã‚‹å…±é€šé–¢æ•° ---
  function startProcess(action, payload) {
    const allSettings = getSettingsFromForm();
    
    // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
    if (!allSettings.deploymentId || !allSettings.apiKey || !allSettings.aiModel) {
      statusMessage.textContent = "APIãƒ»é€£æºè¨­å®šã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      if (!collapsible.classList.contains('active')) {
        collapsible.click();
      }
      return;
    }

    if (action === 'generateSlidesWithAI' && !payload.prompt.trim()) {
        statusMessage.textContent = "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
    }

    generateBtn.disabled = true;
    regenerateBtn.disabled = true;
    statusMessage.textContent = "å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...";

    if (port) port.disconnect();
    port = chrome.runtime.connect({ name: "generate-channel" });

    port.onMessage.addListener((msg) => {
        statusMessage.textContent = msg.message;
        if (msg.status === 'success' || msg.status === 'error') {
            generateBtn.disabled = false;
            regenerateBtn.disabled = false;
            if (port) port.disconnect();
        }
    });

    port.onDisconnect.addListener(() => {
        if (!statusMessage.textContent.startsWith("å®Œäº†") && !statusMessage.textContent.startsWith("ã‚¨ãƒ©ãƒ¼")) {
            statusMessage.textContent = "ã‚¨ãƒ©ãƒ¼: æ¥ç¶šãŒäºˆæœŸã›ãšåˆ‡ã‚Œã¾ã—ãŸã€‚";
        }
        generateBtn.disabled = false;
        regenerateBtn.disabled = false;
        port = null;
    });
    
    port.postMessage({ action, ...payload });
  }


  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼: ç”Ÿæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ ---
  generateBtn.addEventListener('click', () => {
    startProcess('generateSlidesWithAI', {
        prompt: userPrompt.value,
        settings: getSettingsFromForm()
    });
  });

  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼: å†ç”Ÿæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ ---
  regenerateBtn.addEventListener('click', () => {
    startProcess('regenerateWithDesign', {
        settings: getSettingsFromForm()
    });
  });
});